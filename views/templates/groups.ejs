<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Groups - <%= username %>'s Chat Rooms</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/groups_styles.css">
</head>
<body>
    <div class="content-box">
        <div class="container">
            <!-- Header Section -->
            <header class="header">
                <!-- <h1>Groups</h1> -->
            </header>

            <!-- Main Content Area -->
            <div class="main-content">
                <!-- Left Sidebar: Group List -->
                <div class="groups-list">
                    <h2>Your Groups</h2>
                    <% if (error) { %>
                        <p class="error"><%= error %></p>
                    <% } %>
                    <% if (rooms && rooms.length > 0) { %>
                        <ul id="group-list">
                            <% rooms.forEach(room => { %>
                                <li class="group-item" data-room-id="<%= room.room_id %>">
                                    <div class="group-image">
                                        <img src="/profile_placeholder.png" alt="Group Placeholder">
                                    </div>
                                    <div class="group-info">
                                        <p class="group-name"><%= room.name %></p>
                                    </div>
                                </li>
                            <% }); %>
                        </ul>
                    <% } else { %>
                        <p class="no-groups">No groups joined yet.</p>
                    <% } %>
                </div>

                <!-- Right Main Area: Message Display -->
                <div class="chat-panel" id="chat-panel">
                    <div class="message-list" id="message-list">
                        <!-- Messages will be dynamically inserted here -->
                    </div>
                    <div class="message-input">
                        <div class="input-wrapper">
                            <input type="text" placeholder="Type a message...">
                            <button>Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const groupItems = document.querySelectorAll('.group-item');
            const messageList = document.getElementById('message-list');
            const currentUserId = '<%= userId %>';
            const sendButton = document.querySelector('.input-wrapper button');
            const messageInput = document.querySelector('.input-wrapper input');
            let activeRoomId = null;
    
            // Helper function to format dates as yyyy-mm-dd
            function formatDateToYYYYMMDD(date) {
                const d = new Date(date);
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
    
            groupItems.forEach(item => {
                item.addEventListener('click', async () => {
                    const roomId = item.getAttribute('data-room-id');
                    activeRoomId = roomId;
                    try {
                        const response = await fetch(`/api/messages/${roomId}`);
                        const data = await response.json();
                        const messages = data.messages;
    
                        // Clear previous messages
                        messageList.innerHTML = '';
    
                        // Render messages
                        messages.forEach(msg => {
                            const isCurrentUser = msg.user_id === currentUserId;
                            const messageClass = isCurrentUser ? 'message sent' : 'message received';
                            const messageHtml = `
                                <div class="${messageClass}">
                                    ${!isCurrentUser ? `<img src="${msg.profile_img || 'https://via.placeholder.com/40'}" alt="${msg.username}" class="profile-pic">` : ''}
                                    <div class="message-content">
                                        <div class="message-text">${msg.text}</div>
                                        <div class="message-time">${formatDateToYYYYMMDD(msg.sent_datetime)}</div>
                                    </div>
                                </div>
                            `;
                            messageList.innerHTML += messageHtml;
                        });
    
                        // Scroll to bottom
                        messageList.scrollTop = messageList.scrollHeight;
                    } catch (error) {
                        console.error('Error fetching messages:', error);
                        messageList.innerHTML = '<p>Error loading messages</p>';
                    }
                });
            });
    
            sendButton.addEventListener('click', async () => {
                const text = messageInput.value.trim();
                if (!activeRoomId) {
                    alert('Please select a group to send a message.');
                    return;
                }
                if (text === '') return;
    
                try {
                    const response = await fetch('/api/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ roomId: activeRoomId, text })
                    });
                    const data = await response.json();
                    if (data.success) {
                        // Append the new message using the same styling for sent messages
                        const messageHtml = `
                            <div class="message sent">
                                <div class="message-content">
                                    <div class="message-text">${text}</div>
                                    <div class="message-time">${formatDateToYYYYMMDD(data.sent_datetime)}</div>
                                </div>
                            </div>
                        `;
                        messageList.innerHTML += messageHtml;
                        messageList.scrollTop = messageList.scrollHeight;
                        messageInput.value = '';
                    } else {
                        console.error('Error sending message:', data.error);
                    }
                } catch (error) {
                    console.error('Error sending message:', error);
                }
            });
        });
    </script>
    
</body>
</html>